agent:
  mode: moderate   # low/moderate/high
  maxChangedFiles: 50
  require_tests: true
  require_readme_update_on_api_change: true

allow:
  paths:
    - "apps/api/**"
    - "apps/web/**"
    - "apps/bot/**"
    - "packages/**"
    - "infra/**"
  languages: ["ts", "tsx", "json", "yml", "yaml", "sql", "md"]
  ci_changes_label: "ci-change"

deny:
  paths:
    - ".github/workflows/**"     # unless issue has label "ci-change"
    - "**/*.pem"
    - "**/.env"
    - "**/secrets/**"
  patterns:
    - "AKIA[0-9A-Z]{16}"         # AWS keys
    - "-----BEGIN PRIVATE KEY-----"

tests:
  unit_threshold: 0.9
  suites:
    - name: typecheck
      cmd: "pnpm -w tsc -b"
      timeout: 180
    - name: lint
      cmd: "pnpm -w lint"
      timeout: 120
    - name: unit
      cmd: "pnpm -w test -- --run"
      timeout: 600
    - name: integration
      cmd: "docker compose -f infra/compose.yaml up -d && pnpm -w test -- --grep @integration"
      timeout: 900
    - name: e2e-min
      cmd: "pnpm --filter @apps/web test -- --grep @e2e:smoke"
      timeout: 900
    - name: semgrep
      cmd: "semgrep scan --error --config p/owasp-top-ten"
      timeout: 300
    - name: secrets
      cmd: "trufflehog filesystem --fail --since-commit HEAD~1 ."
      timeout: 300

guards:
  forbid_live_trading: true
  env_overrides:
    LIVE_TRADING_ENABLED: "false"
    BITGET_ENV: "paper"
  allowed_symbols: ["BTCUSDT","ETHUSDT","BNBUSDT"]

edits:
  # Add GET /v1/ping endpoint
  - glob: "apps/api/src/index.ts"
    strategy: "append"
    replace: |
      
      // Ping endpoint
      app.get('/v1/ping', (req, res) => {
        res.json({ ok: true })
      })
  
  # Add unit test for ping endpoint
  - glob: "apps/api/tests/ping.spec.ts"
    strategy: "replace"
    replace: |
      import request from 'supertest'
      import { app } from '../src/index'
      
      describe('GET /v1/ping', () => {
        it('should return { ok: true }', async () => {
          const response = await request(app)
            .get('/v1/ping')
            .expect(200)
          
          expect(response.body).toEqual({ ok: true })
        })
      })
  
  # Update README with new endpoint
  - glob: "README.md"
    strategy: "regex-replace"
    search: "(## API Endpoints.*?)(?=##|$)"
    replace: "$1\n- `GET /v1/ping` - Health check endpoint\n\n"
    regexFlags: "s"